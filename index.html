<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nowify — Kiosk</title>
  <style>
    :root{
      --fg:#f4f7fb;
      --muted:#c3cad6;
      --accent:#1db954;
      --shadow: 0 30px 60px rgba(0,0,0,.55);
      --glow: 0 0 160px 60px rgba(0,0,0,.55) inset;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#080a0d;color:var(--fg);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;overflow:hidden}
    .stage{
      position:fixed;inset:0;display:grid;place-items:center;
    }
    /* Blurred background image */
    .bg-wrap{position:absolute;inset:0;overflow:hidden}
    .bg-img{
      position:absolute;inset:-6vh -6vw; /* overscan to hide blur edges */
      width:112vw;height:112vh;object-fit:cover;filter:blur(48px) brightness(.55) saturate(1.15);
      transform:scale(1.1);
    }
    .vignette{
      position:absolute;inset:0;pointer-events:none;
      background:
        radial-gradient(1200px 1200px at 50% 30%, rgba(255,255,255,.12), transparent 45%),
        linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.65));
      box-shadow:var(--glow);
    }
    /* Center content */
    .panel{
      position:relative; z-index:2;
      display:grid; grid-template-columns:1fr; place-items:center; gap:28px;
      text-align:center; padding:24px; width:min(92vw, 1200px);
    }
    .art{
      width:clamp(280px, 42vmin, 720px); height:clamp(280px, 42vmin, 720px);
      border-radius:24px; object-fit:cover; box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.15);
      background:#0c0f14;
    }
    .title{font-weight:800; letter-spacing:.2px;
      font-size:clamp(28px, 5.2vmin, 64px); text-shadow:0 2px 8px rgba(0,0,0,.55);
      max-width:92vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .artists{
      color:var(--muted);
      font-size:clamp(18px, 3.4vmin, 36px);
      max-width:92vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .chips{display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap; opacity:.9}
    .chip{border:1px solid rgba(255,255,255,.22); padding:.35rem .75rem; border-radius:999px; font-weight:600; font-size:clamp(12px,2vmin,16px); backdrop-filter:blur(6px); background:rgba(0,0,0,.25)}
    .progress{
      width:min(86vw, 1100px); height:16px; border-radius:999px; border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35); overflow:hidden;
    }
    .bar{height:100%; width:0%; background:linear-gradient(90deg, rgba(255,255,255,.95), rgba(255,255,255,.45)); transition:width .5s ease}
    .times{display:flex; width:min(86vw, 1100px); justify-content:space-between; color:var(--muted); font-feature-settings:"tnum" 1; font-variant-numeric:tabular-nums; margin-top:6px}
    /* Status */
    .status{
      position:fixed; top:16px; left:16px; font-size:14px; color:#b1b8c8; opacity:.85; z-index:3
    }
    /* Tiny gear to open settings (hidden after login on kiosk) */
    .gear{
      position:fixed; right:16px; bottom:16px; width:44px; height:44px; border-radius:12px;
      display:grid; place-items:center; border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.35); color:var(--fg); cursor:pointer; z-index:3
    }
    .gear.hidden{display:none}
    /* Settings drawer */
    .drawer{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:4;
      background:rgba(0,0,0,.6);
    }
    .drawer.open{display:flex}
    .sheet{
      width:min(720px, 92vw); background:rgba(8,10,13,.9); border:1px solid rgba(255,255,255,.12);
      border-radius:18px; padding:22px; color:var(--fg); box-shadow:var(--shadow)
    }
    .row{display:grid; grid-template-columns:160px 1fr; gap:12px; align-items:center; margin:10px 0}
    label{opacity:.85}
    input{
      width:100%; padding:.7rem .8rem; border-radius:12px; border:1px solid rgba(255,255,255,.15);
      background:#0e1118; color:var(--fg); font-size:16px
    }
    .btns{display:flex; gap:12px; justify-content:flex-end; margin-top:14px}
    .btn{appearance:none; border:1px solid rgba(255,255,255,.18); background:#121621; color:var(--fg);
         padding:.65rem 1rem; border-radius:12px; font-weight:700; cursor:pointer}
    .btn.primary{background:var(--accent); border-color:transparent; color:#052d16}
    .toast{
      position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
      background:#0e1118; border:1px solid rgba(255,255,255,.12); color:var(--fg);
      padding:.6rem .8rem; border-radius:12px; box-shadow:var(--shadow); display:none; z-index:10
    }
  </style>
</head>
<body>
  <div class="stage">
    <div class="bg-wrap">
      <img id="bg" class="bg-img" alt="" />
      <div class="vignette"></div>
    </div>

    <div class="status" id="status">Idle</div>

    <div class="panel">
      <img id="art" class="art" alt="Album art" />
      <div class="title" id="title">Not playing</div>
      <div class="artists" id="artists">—</div>
      <div class="chips">
        <span class="chip" id="stateChip">Stopped</span>
        <span class="chip" id="deviceChip"></span>
        <span class="chip" id="explicitChip">EXPLICIT</span>
        <span class="chip" id="volumeChip"></span>
        <span class="chip" id="whoami"></span>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
      <div class="times"><div id="elapsed">0:00</div><div id="duration">0:00</div></div>
    </div>

    <div class="gear" id="gear" title="Settings (press 's')">⚙︎</div>

    <div class="drawer" id="drawer">
      <div class="sheet">
        <h2 style="margin:0 0 8px 0;">Nowify Settings</h2>
        <p style="margin:0 0 14px 0; color:#b1b8c8">Enter your Spotify Client ID and confirm the Redirect URI.</p>
        <div class="row">
          <label for="clientId">Client ID</label>
          <input id="clientId" placeholder="Spotify Client ID" />
        </div>
        <div class="row">
          <label for="redirectUri">Redirect URI</label>
          <input id="redirectUri" placeholder="https://USERNAME.github.io/REPO/" />
        </div>
        <div class="btns">
          <button class="btn" id="clearBtn">Clear data</button>
          <button class="btn" id="logoutBtn">Log out</button>
          <button class="btn primary" id="loginBtn">Log in with Spotify</button>
          <button class="btn" id="closeBtn">Close</button>
        </div>
        <p style="margin:12px 0 0 0; color:#9aa6b6; font-size:14px;">
          Tip: Press <b>s</b> anytime to open this panel. Tokens are stored only in this browser.
        </p>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
  // ---------- Utilities ----------
  const $ = s => document.querySelector(s);
  const fmtTime = ms => { if(!Number.isFinite(ms)||ms<0) ms=0; const s=Math.floor(ms/1000),m=Math.floor(s/60),r=s%60; return m+":"+String(r).padStart(2,"0"); };
  const b64url = arr => btoa(String.fromCharCode(...new Uint8Array(arr))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
  const rand = (len=64) => { const c="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._~"; let s=""; for(let i=0;i<len;i++) s+=c[Math.floor(Math.random()*c.length)]; return s; };
  const toast=(m)=>{const t=$("#toast"); t.textContent=m; t.style.display="block"; setTimeout(()=>t.style.display="none",2400);};

  // ---------- Storage ----------
  const store={ get k(){return JSON.parse(localStorage.getItem("nowify_cfg")||"{}")},
                set k(v){localStorage.setItem("nowify_cfg",JSON.stringify(v))},
                set(a,b){const o=this.k;o[a]=b;this.k=o}, get(a){return this.k[a]}, clear(){localStorage.removeItem("nowify_cfg")} };

  // ---------- OAuth (PKCE) ----------
  const SCOPES=[ "user-read-email","user-read-private","user-read-currently-playing","user-read-playback-state" ].join(" ");

  async function beginLogin(){
    const clientId = store.get("client_id"); const redirectUri = store.get("redirect_uri") || (location.origin + location.pathname);
    if(!clientId){ toast("Enter Client ID in settings (press 's')."); openDrawer(); return; }
    const state = rand(16); const verifier = rand(64);
    const digest = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(verifier));
    const challenge=b64url(digest);
    store.set("code_verifier",verifier); store.set("oauth_state",state);
    const url=new URL("https://accounts.spotify.com/authorize");
    url.searchParams.set("response_type","code");
    url.searchParams.set("client_id",clientId);
    url.searchParams.set("scope",SCOPES);
    url.searchParams.set("redirect_uri",redirectUri);
    url.searchParams.set("state",state);
    url.searchParams.set("code_challenge_method","S256");
    url.searchParams.set("code_challenge",challenge);
    location.href=url.toString();
  }
  async function exchangeCodeForToken(code){
    const clientId=store.get("client_id"); const redirectUri=store.get("redirect_uri") || (location.origin + location.pathname);
    const verifier=store.get("code_verifier");
    const body=new URLSearchParams({client_id:clientId, grant_type:"authorization_code", code, redirect_uri:redirectUri, code_verifier:verifier});
    const res=await fetch("https://accounts.spotify.com/api/token",{method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"}, body});
    if(!res.ok) throw new Error("Token exchange failed: "+res.status);
    const data=await res.json(); persistTokens(data); return data;
  }
  async function refreshToken(){
    const clientId=store.get("client_id"); const r=store.get("refresh_token"); if(!r) return;
    const body=new URLSearchParams({client_id:clientId, grant_type:"refresh_token", refresh_token:r});
    const res=await fetch("https://accounts.spotify.com/api/token",{method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"}, body});
    if(!res.ok) throw new Error("Refresh failed: "+res.status);
    const data=await res.json(); persistTokens(data,true); return data;
  }
  function persistTokens(d, keep=false){
    if(d.access_token) store.set("access_token", d.access_token);
    if(d.expires_in) store.set("expires_at", Date.now() + (d.expires_in-30)*1000);
    if(d.refresh_token) store.set("refresh_token", d.refresh_token);
    else if(keep){/* keep old refresh token */}
  }
  function logout(){ store.set("access_token",null); store.set("refresh_token",null); store.set("expires_at",0); $("#whoami").textContent=""; updateStatus("Logged out"); }

  // ---------- API ----------
  async function api(path){
    let at=store.get("access_token"); let exp=store.get("expires_at")||0;
    if(!at) throw new Error("No access token");
    if(Date.now()>exp){ try{ await refreshToken(); }catch(e){ console.error(e);} at=store.get("access_token"); }
    const res=await fetch("https://api.spotify.com/v1"+path,{headers:{Authorization:`Bearer ${at}`}});
    if(res.status===204) return null;
    if(res.status===401){ await refreshToken(); return api(path); }
    if(!res.ok) throw new Error("API "+path+" failed: "+res.status);
    return await res.json();
  }

  // ---------- Render ----------
  const art=$("#art"), bg=$("#bg"), titleEl=$("#title"), artistsEl=$("#artists");
  const bar=$("#bar"), elapsedEl=$("#elapsed"), durationEl=$("#duration");
  const deviceChip=$("#deviceChip"), stateChip=$("#stateChip"), explicitChip=$("#explicitChip"), volumeChip=$("#volumeChip");

  function updateStatus(s){ $("#status").textContent=s; }

  function renderNothing(){
    titleEl.textContent="Nothing playing";
    artistsEl.textContent="—";
    stateChip.textContent="Stopped";
    elapsedEl.textContent="0:00"; durationEl.textContent="0:00"; bar.style.width="0%";
    art.src=""; bg.src=""; explicitChip.style.display="none"; deviceChip.textContent=""; volumeChip.textContent="";
  }
  function renderPlayback(d){
    if(!d || !d.item){ renderNothing(); return; }
    const t=d.item;
    titleEl.textContent=t.name||"—";
    artistsEl.textContent=(t.artists||[]).map(a=>a.name).join(", ")||"—";
    const img=(t.album&&t.album.images&&t.album.images[0]&&t.album.images[0].url)||"";
    if(img){ art.src=img; if(bg.src!==img) bg.src=img; }
    const dur=t.duration_ms||0, pos=d.progress_ms||0;
    durationEl.textContent=fmtTime(dur); elapsedEl.textContent=fmtTime(pos);
    bar.style.width = dur ? (pos/dur*100).toFixed(2)+"%" : "0%";
    stateChip.textContent=d.is_playing?"Playing":"Paused";
    explicitChip.style.display = t.explicit ? "inline-block" : "none";
    deviceChip.textContent = d.device ? (d.device.name||"") : "";
    volumeChip.textContent = d.device && Number.isFinite(d.device.volume_percent) ? `Vol ${d.device.volume_percent}%` : "";
  }

  // ---------- Polling ----------
  let timer=null, lastETag=null;
  async function tick(){
    try{
      updateStatus("Polling…");
      const headers={}; if(lastETag) headers["If-None-Match"]=lastETag;
      let at=store.get("access_token"); if(!at){ updateStatus("Not authenticated"); return; }
      const res=await fetch("https://api.spotify.com/v1/me/player/currently-playing",{headers:{Authorization:`Bearer ${at}`,...headers}});
      if(res.status===401){ await refreshToken(); return; }
      if(res.status===204){ renderNothing(); updateStatus("No content"); return; }
      if(res.status===304){ updateStatus("Unchanged"); return; }
      if(!res.ok) throw new Error("Status "+res.status);
      lastETag = res.headers.get("ETag") || lastETag;
      const data=await res.json(); renderPlayback(data);
      updateStatus(data && data.is_playing ? "Playing" : "Paused");
    }catch(e){ console.error(e); updateStatus("Error"); }
  }
  function start(){ if(timer) clearInterval(timer); tick(); timer=setInterval(tick, 5000); }

  async function whoami(){ try{ const me=await api("/me"); $("#whoami").textContent = me ? (me.display_name||me.id) : ""; }catch{} }

  // ---------- Settings Drawer & UI ----------
  const drawer=$("#drawer"), gear=$("#gear");
  function openDrawer(){ drawer.classList.add("open"); }
  function closeDrawer(){ drawer.classList.remove("open"); }
  $("#loginBtn").onclick=beginLogin;
  $("#logoutBtn").onclick=()=>{ logout(); renderNothing(); toast("Logged out"); openDrawer(); };
  $("#closeBtn").onclick=closeDrawer;
  $("#clearBtn").onclick=()=>{ store.clear(); toast("Cleared stored data"); location.reload(); };
  gear.onclick=openDrawer;
  document.addEventListener("keydown",(e)=>{ if(e.key.toLowerCase()==="s") openDrawer(); });

  // Save settings
  const saveSettings=()=>{
    store.set("client_id", $("#clientId").value.trim());
    store.set("redirect_uri", $("#redirectUri").value.trim());
    toast("Settings saved");
  };
  $("#clientId").addEventListener("change", saveSettings);
  $("#redirectUri").addEventListener("change", saveSettings);

  // ---------- Wake Lock (keep screen on if supported) ----------
  let wl=null;
  async function lockScreen(){
    try{ if("wakeLock" in navigator){ wl=await navigator.wakeLock.request("screen"); wl.addEventListener("release",()=>console.log("Wake lock released")); } }catch(e){ console.log("WakeLock unsupported", e); }
  }
  document.addEventListener("visibilitychange",()=>{ if(document.visibilityState==="visible" && wl && wl.released){ lockScreen(); } });

  // ---------- Init ----------
  (async function init(){
    $("#clientId").value = store.get("client_id") || "";
    $("#redirectUri").value = store.get("redirect_uri") || (location.origin + location.pathname);

    const params=new URLSearchParams(location.search);
    if(params.has("code")){
      try{
        const code=params.get("code"); const state=params.get("state");
        if(state !== store.get("oauth_state")) throw new Error("State mismatch");
        updateStatus("Completing login…");
        await exchangeCodeForToken(code);
        history.replaceState({}, "", store.get("redirect_uri") || (location.origin + location.pathname));
        toast("Logged in");
      }catch(e){ console.error(e); toast("Login failed. Open settings with 's' and check."); }
    }

    if(store.get("access_token")){
      await whoami();
      start();
      lockScreen();
      // Hide gear after successful login for kiosk cleanliness (still open with 's')
      gear.classList.add("hidden");
    }else{
      renderNothing();
      updateStatus("Not authenticated");
      openDrawer();
    }
  })();
  </script>
</body>
</html>
