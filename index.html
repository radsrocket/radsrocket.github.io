<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nowify — Dual Account</title>
  <style>
    :root {
      --bg: #000;
      --fg: #fff;
      --muted: #bdbdbd;
      --accent: #1db954; /* Spotify-ish */
      --error: #ff4d4f;
      --progress-h: 18px;
      --gutter: 4vmin;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .root { display: grid; grid-template-columns: minmax(280px, 40%) 1fr; gap: var(--gutter); height: 100%; align-items: center; padding: var(--gutter); box-sizing: border-box; }
    .art { width: 100%; aspect-ratio: 1/1; background: #111; border-radius: 2vmin; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,.6); }
    .art img { width: 100%; height: 100%; object-fit: cover; display: block; }

    .meta { display: grid; grid-template-rows: 1fr auto; gap: 2vmin; min-width: 0; }
    .titles { min-width: 0; }
    .title { font-size: clamp(24px, 8vmin, 64px); font-weight: 800; line-height: 1.05; margin: 0 0 .6rem 0; word-break: break-word; }
    .artist { font-size: clamp(16px, 4.2vmin, 32px); color: var(--muted); margin: 0; white-space: pre-wrap; word-break: break-word; }

    .bar { position: relative; height: var(--progress-h); background: #2a2a2a; border-radius: 999px; overflow: hidden; box-shadow: inset 0 1px 0 rgba(255,255,255,.06); }
    .bar-fill { position: absolute; inset: 0; width: 0%; background: var(--fg); transition: width .4s linear; }

    .footer { display: flex; align-items: center; justify-content: space-between; gap: 1rem; opacity: .9; font-size: 14px; }
    .account-pill { display: inline-flex; align-items: center; gap: .5rem; padding: .3rem .6rem; border-radius: 999px; background: rgba(255,255,255,.1); }
    .account-dot { width: .6rem; height: .6rem; border-radius: 999px; background: var(--accent); }

    .gear { position: fixed; top: .9rem; right: .9rem; width: 36px; height: 36px; border-radius: 999px; display: grid; place-items: center; cursor: pointer; background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.18); backdrop-filter: blur(6px); }
    .gear:hover { background: rgba(255,255,255,.16); }
    .gear svg { width: 22px; height: 22px; fill: var(--fg); opacity: .9; }

    .settings { position: fixed; inset: 0; display: none; }
    .settings.open { display: grid; }
    .settings .scrim { position: absolute; inset: 0; background: rgba(0,0,0,.6); }
    .settings .panel { position: relative; margin: auto; width: min(940px, 92%); max-height: 86%; overflow: auto; background: #0d0d0d; border: 1px solid #1a1a1a; border-radius: 18px; padding: 24px; box-shadow: 0 30px 80px rgba(0,0,0,.6); }
    .settings h2 { margin: 0 0 .6rem 0; font-size: 22px; }
    .settings p.note { color: var(--muted); margin-top: .2rem; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; margin: 18px 0; }
    label { font-size: 12px; text-transform: uppercase; letter-spacing: .06em; color: var(--muted); display: block; margin-bottom: 6px; }
    input[type=text] { width: 100%; padding: 10px 12px; border-radius: 10px; background: #121212; color: var(--fg); border: 1px solid #2a2a2a; }
    select { width: 100%; padding: 10px 12px; border-radius: 10px; background: #121212; color: var(--fg); border: 1px solid #2a2a2a; }
    button { appearance: none; border: 0; background: var(--accent); color: #000; padding: 10px 14px; border-radius: 12px; font-weight: 700; cursor: pointer; }
    button.secondary { background: #202020; color: var(--fg); border: 1px solid #2a2a2a; }
    .hr { height: 1px; background: #1a1a1a; margin: 18px 0; }

    .net { position: fixed; left: 50%; transform: translateX(-50%); bottom: 14px; background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.2); padding: 8px 12px; border-radius: 999px; font-size: 12px; display: none; }
    .net.show { display: inline-flex; align-items: center; gap: 8px; }
    .net .dot { width: 8px; height: 8px; border-radius: 999px; background: var(--error); }

    .blackout { position: fixed; inset: 0; background: #000; opacity: 0; pointer-events: none; transition: opacity .25s ease; }
    .blackout.show { opacity: 1; }

    @media (max-width: 900px) {
      .root { grid-template-columns: 1fr; grid-auto-rows: max-content; }
    }
  </style>
</head>
<body>
  <div class="root" id="root">
    <div class="art" id="art"><img id="artImg" alt="" /></div>
    <div class="meta">
      <div class="titles">
        <h1 class="title" id="title">Paused</h1>
        <p class="artist" id="artist">—</p>
      </div>
      <div>
        <div class="bar"><div class="bar-fill" id="fill"></div></div>
        <div class="footer">
          <div class="account-pill" id="acctPill" title="Which account is shown">
            <span class="account-dot" id="acctDot"></span>
            <span id="acctLabel">No account</span>
          </div>
          <span id="timeText">0:00 / 0:00</span>
        </div>
      </div>
    </div>
  </div>

  <div class="gear" id="gear" title="Settings (press ‘s’)" aria-label="Settings">
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M19.14,12.94a7.77,7.77,0,0,0,.06-1,7.77,7.77,0,0,0-.06-1l2.11-1.65a.5.5,0,0,0,.12-.64l-2-3.46a.5.5,0,0,0-.6-.22l-2.49,1a7.28,7.28,0,0,0-1.73-1L14.5,1.61a.5.5,0,0,0-.5-.41H10a.5.5,0,0,0-.5.41L9,4.97a7.28,7.28,0,0,0-1.73,1l-2.49-1a.5.5,0,0,0-.6.22l-2,3.46a.5.5,0,0,0,.12.64L3.86,10a7.77,7.77,0,0,0-.06,1,7.77,7.77,0,0,0,.06,1L1.75,13.65a.5.5,0,0,0-.12.64l2,3.46a.5.5,0,0,0,.6.22l2.49-1a7.28,7.28,0,0,0,1.73,1l.5,3.36a.5.5,0,0,0,.5.41h4a.5.5,0,0,0,.5-.41l.5-3.36a7.28,7.28,0,0,0,1.73-1l2.49,1a.5.5,0,0,0,.6-.22l2-3.46a.5.5,0,0,0-.12-.64ZM12,15.5A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/></svg>
  </div>

  <div class="settings" id="settings">
    <div class="scrim" data-close></div>
    <div class="panel">
      <h2>Nowify — Dual Account</h2>
      <p class="note">Press <kbd>s</kbd> to open/close this panel. Tokens are stored in <code>localStorage</code> on this origin only.</p>

      <div class="row">
        <div>
          <label>Spotify Client ID</label>
          <input type="text" id="clientId" placeholder="Paste your Spotify Client ID" />
        </div>
        <div>
          <label>Redirect URI</label>
          <input type="text" id="redirectUri" />
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div>
          <h2>Account A</h2>
          <p class="note" id="aStatus">Not connected</p>
          <div style="display:flex; gap:10px; flex-wrap: wrap;">
            <button id="aLogin">Log in as A</button>
            <button id="aLogout" class="secondary">Log out A</button>
          </div>
        </div>
        <div>
          <h2>Account B</h2>
          <p class="note" id="bStatus">Not connected</p>
          <div style="display:flex; gap:10px; flex-wrap: wrap;">
            <button id="bLogin">Log in as B</button>
            <button id="bLogout" class="secondary">Log out B</button>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label>Preference when both are playing</label>
          <select id="prefer">
            <option value="A">Prefer Account A</option>
            <option value="B">Prefer Account B</option>
          </select>
        </div>
        <div>
          <label>Polling interval (ms)</label>
          <input type="text" id="pollMs" />
        </div>
      </div>

      <div class="row">
        <div>
          <label>Blackout screen when nothing is playing</label>
          <select id="blackoutPaused">
            <option value="false">Show paused screen</option>
            <option value="true">Blackout</option>
          </select>
        </div>
      </div>

      <div style="display:flex; gap:10px; justify-content:flex-end; margin-top: 6px;">
        <button id="save">Save</button>
        <button id="close" class="secondary">Close</button>
      </div>
    </div>
  </div>

  <div class="net" id="net"><span class="dot"></span> Network issue — retrying…</div>
  <div class="blackout" id="blackout"></div>

  <script>
    // ===== Config & storage =====
    const CFG_KEY = 'nowify_cfg_v2';
    const DEFAULT_CFG = {
      clientId: '',
      redirectUri: location.origin + location.pathname,
      accounts: {
        A: { label: 'Account A', tokens: null, profile: null, lastAuth: 0 },
        B: { label: 'Account B', tokens: null, profile: null, lastAuth: 0 },
      },
      preferred: 'A',
      pollingMs: 2500,
      blackoutPaused: false,
    };

    let cfg = loadCfg();
    function loadCfg(){
      try { return { ...DEFAULT_CFG, ...(JSON.parse(localStorage.getItem(CFG_KEY))||{}) }; } catch { return { ...DEFAULT_CFG }; }
    }
    function saveCfg(){ localStorage.setItem(CFG_KEY, JSON.stringify(cfg)); }

    // ===== UI refs =====
    const artImg = document.getElementById('artImg');
    const titleEl = document.getElementById('title');
    const artistEl = document.getElementById('artist');
    const fillEl = document.getElementById('fill');
    const acctPill = document.getElementById('acctPill');
    const acctLabel = document.getElementById('acctLabel');
    const acctDot = document.getElementById('acctDot');
    const timeText = document.getElementById('timeText');
    const blackout = document.getElementById('blackout');
    const net = document.getElementById('net');

    // Settings refs
    const settings = document.getElementById('settings');
    const clientId = document.getElementById('clientId');
    const redirectUri = document.getElementById('redirectUri');
    const aStatus = document.getElementById('aStatus');
    const bStatus = document.getElementById('bStatus');
    const aLogin = document.getElementById('aLogin');
    const bLogin = document.getElementById('bLogin');
    const aLogout = document.getElementById('aLogout');
    const bLogout = document.getElementById('bLogout');
    const prefer = document.getElementById('prefer');
    const pollMs = document.getElementById('pollMs');
    const blackoutPausedSel = document.getElementById('blackoutPaused');
    const saveBtn = document.getElementById('save');

    // ===== OAuth (PKCE) helpers =====
    const SPOTIFY_AUTH = 'https://accounts.spotify.com/authorize';
    const SPOTIFY_TOKEN = 'https://accounts.spotify.com/api/token';
    const SCOPES = 'user-read-currently-playing user-read-playback-state';

    async function sha256(str){ const enc = new TextEncoder().encode(str); const buf = await crypto.subtle.digest('SHA-256', enc); return new Uint8Array(buf); }
    function base64url(bytes){ let s = btoa(String.fromCharCode(...bytes)); return s.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,''); }
    function randString(len=64){ const ab = new Uint8Array(len); crypto.getRandomValues(ab); return base64url(ab).slice(0,len); }

    async function beginLogin(which){
      if(!cfg.clientId){ openSettings(); alert('Set your Spotify Client ID first.'); return; }
      const verifier = randString(64);
      const challenge = base64url(await sha256(verifier));
      sessionStorage.setItem(`nowify_pkce_${which}`, verifier);
      const state = `nowify|${which}|${Date.now()}`;
      const url = new URL(SPOTIFY_AUTH);
      url.search = new URLSearchParams({
        response_type: 'code',
        client_id: cfg.clientId,
        redirect_uri: cfg.redirectUri,
        code_challenge_method: 'S256',
        code_challenge: challenge,
        scope: SCOPES,
        state,
        show_dialog: 'true',
      }).toString();
      location.assign(url.toString());
    }

    async function completeLogin(){
      const params = new URLSearchParams(location.search);
      const code = params.get('code');
      const state = params.get('state');
      if(!code || !state || !state.startsWith('nowify|')) return false;
      const parts = state.split('|');
      const which = parts[1] === 'A' ? 'A' : 'B';
      const verifier = sessionStorage.getItem(`nowify_pkce_${which}`);
      if(!verifier){ console.warn('Missing PKCE verifier'); return false; }

      try{
        const body = new URLSearchParams({
          client_id: cfg.clientId,
          grant_type: 'authorization_code',
          code, redirect_uri: cfg.redirectUri,
          code_verifier: verifier,
        });
        const r = await fetch(SPOTIFY_TOKEN, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body });
        if(!r.ok){ throw new Error('Token exchange failed'); }
        const tok = await r.json();
        const now = Date.now();
        cfg.accounts[which].tokens = {
          access_token: tok.access_token,
          refresh_token: tok.refresh_token,
          expires_at: now + (tok.expires_in*1000 - 15_000),
        };
        cfg.accounts[which].lastAuth = now;
        saveCfg();
        await loadProfile(which);
      }catch(err){ console.error(err); alert('Login failed: '+err.message); }
      finally{
        // Clean URL
        history.replaceState({}, '', cfg.redirectUri);
      }
      return true;
    }

    async function refreshToken(which){
      const t = cfg.accounts[which].tokens; if(!t || !t.refresh_token) return false;
      try{
        const body = new URLSearchParams({
          client_id: cfg.clientId,
          grant_type: 'refresh_token',
          refresh_token: t.refresh_token,
        });
        const r = await fetch(SPOTIFY_TOKEN, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body });
        if(!r.ok){ throw new Error('Refresh failed'); }
        const tok = await r.json();
        t.access_token = tok.access_token;
        if(tok.refresh_token) t.refresh_token = tok.refresh_token; // sometimes new one provided
        t.expires_at = Date.now() + (tok.expires_in*1000 - 15_000);
        saveCfg();
        return true;
      }catch(err){ console.warn('Refresh failed', which, err); return false; }
    }

    async function withToken(which, fn){
      const acct = cfg.accounts[which];
      if(!acct.tokens) throw new Error('Not logged in');
      if(Date.now() > acct.tokens.expires_at){ await refreshToken(which); }
      return await fn(acct.tokens.access_token);
    }

    // ===== API helpers =====
    async function apiGet(token, url){
      const r = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
      return r.ok ? r.json() : Promise.reject(r);
    }

    async function loadProfile(which){
      try{
        const me = await withToken(which, (t)=>apiGet(t, 'https://api.spotify.com/v1/me'));
        cfg.accounts[which].profile = { id: me.id, name: me.display_name || me.id };
        saveCfg();
        updateSettingsUI();
      }catch(err){ console.warn('Profile load failed', which, err); }
    }

    async function getPlayback(which){
      try{
        const data = await withToken(which, (t)=>apiGet(t, 'https://api.spotify.com/v1/me/player/currently-playing'));
        if(!data || !data.item){ return { which, ok:true, isPlaying:false, data:null }; }
        const isPlaying = !!data.is_playing && data.currently_playing_type === 'track';
        return { which, ok:true, isPlaying, data };
      }catch(err){
        if(err && err.status === 204) return { which, ok:true, isPlaying:false, data:null }; // no content
        if(err && err.status === 401){ const ok = await refreshToken(which); if(ok) return getPlayback(which); }
        console.warn('Playback failed', which, err);
        return { which, ok:false, isPlaying:false, data:null };
      }
    }

    // ===== Rendering =====
    let lastShown = null; // 'A' | 'B' | null
    let lastData = null;
    let netErrors = 0;
    let rafTicker = null;

    function chooseToShow(aRes, bRes){
      const aPlaying = aRes && aRes.ok && aRes.isPlaying;
      const bPlaying = bRes && bRes.ok && bRes.isPlaying;
      if(aPlaying && bPlaying){ return cfg.preferred; }
      if(aPlaying) return 'A';
      if(bPlaying) return 'B';
      return null;
    }

    function msToClock(ms){ if(!ms && ms!==0) return '0:00'; const s=Math.floor(ms/1000), m=Math.floor(s/60), r=(s%60).toString().padStart(2,'0'); return `${m}:${r}`; }

    function renderNothing(){
      titleEl.textContent = 'Nothing playing';
      artistEl.textContent = "Press 's' to connect accounts or start playback.";
      artImg.removeAttribute('src');
      fillEl.style.width = '0%';
      timeText.textContent = '0:00 / 0:00';
      acctLabel.textContent = '—';
      if (cfg.blackoutPaused) { blackout.classList.add('show'); } else { blackout.classList.remove('show'); }
    }

    function renderPlayback(which, payload){
      blackout.classList.remove('show');
      const item = payload.item; // track
      const artists = (item && item.artists ? item.artists.map(a=>a.name).join(', ') : '') || 'Unknown artist';
      titleEl.textContent = item?.name || 'Unknown track';
      artistEl.textContent = artists;
      const art = (item?.album?.images||[]).sort((a,b)=>b.width-a.width)[0]?.url;
      if(art) artImg.src = art; else artImg.removeAttribute('src');

      // Progress
      const dur = item?.duration_ms || 0;
      const prog = payload.progress_ms || 0;
      timeText.textContent = `${msToClock(prog)} / ${msToClock(dur)}`;
      fillEl.style.width = dur ? `${Math.min(100, (prog/dur)*100).toFixed(2)}%` : '0%';

      // Account pill
      const prof = cfg.accounts[which].profile; 
      acctLabel.textContent = prof ? `${prof.name} (${which})` : (which === 'A' ? 'Account A' : 'Account B');
      acctDot.style.background = which === 'A' ? 'var(--accent)' : '#4d88ff';

      lastShown = which; lastData = payload;
    }

    function tickProgress(){
      if(!lastData) return;
      const dur = lastData.item?.duration_ms || 0; if(!dur) return;
      const prev = parseFloat(fillEl.style.width) || 0;
      const step = (100 / (dur/1000)) * (1/10); // 10fps estimate
      const next = Math.min(100, prev + step);
      fillEl.style.width = next + '%';
      // rough text increment
      const cur = (parseFloat(lastData.progress_ms)||0) + (step/100)*dur; lastData.progress_ms = cur;
      timeText.textContent = `${msToClock(cur)} / ${msToClock(dur)}`;
      rafTicker = setTimeout(tickProgress, 100);
    }

    function cancelTicker(){ if(rafTicker){ clearTimeout(rafTicker); rafTicker = null; } }

    async function poll(){
      const hasA = !!cfg.accounts.A.tokens;
      const hasB = !!cfg.accounts.B.tokens;
      if(!hasA && !hasB){ renderNothing(); return; }

      try{
        const [aRes, bRes] = await Promise.all([
          hasA ? getPlayback('A') : Promise.resolve(null),
          hasB ? getPlayback('B') : Promise.resolve(null),
        ]);
        netErrors = 0; net.classList.remove('show');
        const show = chooseToShow(aRes, bRes);
        cancelTicker();
        if(!show){ renderNothing(); return; }
        const payload = show === 'A' ? aRes.data : bRes.data;
        renderPlayback(show, payload);
        tickProgress();
      }catch(err){
        console.warn('Poll error', err);
        netErrors++; if(netErrors > 5) net.classList.add('show');
      }
    }

    // ===== Settings UI =====
    function openSettings(){ settings.classList.add('open'); fillSettings(); }
    function closeSettings(){ settings.classList.remove('open'); }

    function fillSettings(){
      clientId.value = cfg.clientId || '';
      redirectUri.value = cfg.redirectUri || (location.origin+location.pathname);
      prefer.value = cfg.preferred || 'A';
      pollMs.value = String(cfg.pollingMs || 2500);
      blackoutPausedSel.value = String(!!cfg.blackoutPaused);
      updateSettingsUI();
    }

    function updateSettingsUI(){
      const pa = cfg.accounts.A.profile; const pb = cfg.accounts.B.profile;
      aStatus.textContent = pa ? `Connected as ${pa.name}` : 'Not connected';
      bStatus.textContent = pb ? `Connected as ${pb.name}` : 'Not connected';
    }

    document.getElementById('save').addEventListener('click', ()=>{
      cfg.clientId = clientId.value.trim();
      cfg.redirectUri = redirectUri.value.trim() || (location.origin+location.pathname);
      cfg.preferred = (prefer.value === 'B') ? 'B' : 'A';
      const n = parseInt(pollMs.value, 10); if(!Number.isNaN(n) && n>500) cfg.pollingMs = n;
      cfg.blackoutPaused = (blackoutPausedSel.value === 'true');
      saveCfg();
      closeSettings();
    });

    document.getElementById('close').addEventListener('click', closeSettings);
    document.getElementById('gear').addEventListener('click', openSettings);
    settings.addEventListener('click', (e)=>{ if(e.target.hasAttribute('data-close')) closeSettings(); });

    aLogin.addEventListener('click', ()=>beginLogin('A'));
    bLogin.addEventListener('click', ()=>beginLogin('B'));
    aLogout.addEventListener('click', ()=>{ cfg.accounts.A = { ...DEFAULT_CFG.accounts.A }; saveCfg(); updateSettingsUI(); });
    bLogout.addEventListener('click', ()=>{ cfg.accounts.B = { ...DEFAULT_CFG.accounts.B }; saveCfg(); updateSettingsUI(); });

    // Keyboard shortcut
    document.addEventListener('keydown', (e)=>{ if(e.key.toLowerCase() === 's') settings.classList.toggle('open'); });

    // ===== Boot =====
    (async function boot(){
      // Handle OAuth return
      await completeLogin();
      // Try to enrich profiles if tokens exist but profile missing
      if(cfg.accounts.A.tokens && !cfg.accounts.A.profile) await loadProfile('A');
      if(cfg.accounts.B.tokens && !cfg.accounts.B.profile) await loadProfile('B');
      updateSettingsUI();

      // Initial paint
      renderNothing(); fillSettings();

      // If nothing configured yet, open settings to guide setup
      if(!(cfg.accounts.A.tokens || cfg.accounts.B.tokens) || !cfg.clientId){
        openSettings();
      }

      // Start polling loop
      async function loop(){ await poll(); setTimeout(loop, cfg.pollingMs); }
      loop();
    })();
  </script>
</body>
</html>
