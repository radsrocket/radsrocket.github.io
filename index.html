<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nowify — Kiosk</title>
  <style>
    :root{
      --fg:#f6f8fb;
      --muted:#9aa6b2;
      --accent:#1db954;
      --shadow: 0 40px 80px rgba(0,0,0,.6);
      --gap: 2.2vw; /* kleiner gap */
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:#000;color:var(--fg);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;overflow:hidden}
    .stage{position:fixed;inset:0;display:grid;place-items:center}

    /* Blackout bij pauze / niets */
    .blackout{position:fixed; inset:0; background:#000; display:none; z-index:5}

    /* Netwerkfout overlay */
    .neterr{
      position:fixed; inset:0; display:none; z-index:5;
      pointer-events:none; display:grid; place-items:center;
    }
    .neterr .bubble{
      color:var(--muted);
      font-size:clamp(18px, 3.2vmin, 28px);
      background:rgba(255,255,255,0.06);
      padding:1rem 1.25rem;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.12);
      text-align:center;
    }

    /* Maximale benutting scherm */
    .panel{
      position:relative; z-index:2;
      display:grid;
      grid-template-columns: minmax(680px, 75vmin) minmax(640px, 1fr); /* grotere art + ruime tekstkolom */
      gap:clamp(12px, var(--gap), 36px);
      align-items:center;
      width:99vw; max-width:100vw;
      padding:clamp(6px, 1.2vw, 14px); /* minimale padding */
    }

    .left{display:grid; align-content:center; gap:1.6vmin; min-width:0}
    .right{
      display:grid; align-content:center;
      gap:clamp(10px, 2.6vmin, 28px); /* iets lucht tussen elementen */
      min-width:0;
    }
    .art{
      width:100%;
      aspect-ratio:1/1;
      border-radius:0;
      object-fit:cover; box-shadow:var(--shadow);
      border:0; /* geen rand -> nog iets groter beeld */
      background:#0b0f14;
    }

    /* Grotere basis-typografie; JS zal zo nodig verkleinen en pas als laatste trunceren */
    .title{
      font-weight:800; letter-spacing:.2px;
      font-size:clamp(44px, 9.6vmin, 128px);
      line-height:1.06;
      max-width:100%;
      overflow:visible;
      word-break:break-word;
    }
    .artists{
      color:#c7cfdb;
      font-size:clamp(32px, 7.2vmin, 96px);
      line-height:1.06;
      max-width:100%;
      overflow:visible;
      word-break:break-word;
    }

    /* Progress: dun, donkergrijze rest */
    .progress{
      width:100%; height:18px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:#606a78; /* darker remainder */
      overflow:hidden
    }
    .bar{
      height:100%; width:0%;
      background:linear-gradient(90deg, rgba(255,255,255,.98), rgba(255,255,255,.45));
      background-color:rgba(255,255,255,.9);
    }

    /* Clamping voor laatste redmiddel */
    .clamp{display:-webkit-box; -webkit-box-orient:vertical; overflow:hidden}
    .clamp.title-2{-webkit-line-clamp:2}
    .clamp.title-3{-webkit-line-clamp:3}
    .clamp.artists-1{-webkit-line-clamp:1}
    .clamp.artists-2{-webkit-line-clamp:2}

    /* Gear + settings */
    .gear{position:fixed; right:16px; bottom:16px; width:54px; height:54px; border-radius:16px; display:grid; place-items:center; border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08); color:var(--fg); cursor:pointer; z-index:6; font-size:22px}
    .gear.hidden{display:none}

    .drawer{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:7; background:rgba(0,0,0,.72);}
    .drawer.open{display:flex}

    .sheet{
      width:min(920px,96vw); max-height:92vh; overflow:auto;
      background:#0b0b0b; border:1px solid rgba(255,255,255,.14);
      border-radius:22px; padding:28px;
      color:var(--fg); box-shadow:0 24px 80px rgba(0,0,0,.75);
      font-size:18px;
    }
    .sheet h2{font-size:28px; margin:0 0 4px}
    .sheet p.lead{margin:0 0 18px; color:#c0c7d2}

    .row{display:grid; grid-template-columns:1fr; gap:8px; margin:16px 0}
    .row label{opacity:.9; font-weight:600}
    input{
      width:100%; padding:1rem 1rem; border-radius:14px;
      border:1px solid rgba(255,255,255,.18); background:#101318; color:var(--fg); font-size:18px
    }
    input:focus{outline:2px solid #3b82f6; outline-offset:2px}

    .hint{color:#9aa6b6; font-size:14px; margin-top:6px}
    .error{color:#ffb4b4; font-size:14px; display:none; margin-top:6px}

    .btns{display:flex; flex-wrap:wrap; gap:12px; justify-content:flex-end; margin-top:16px}
    .btn{appearance:none; border:1px solid rgba(255,255,255,.2); background:#171b23; color:var(--fg);
      padding:0.9rem 1.2rem; border-radius:14px; font-weight:700; cursor:pointer; font-size:16px}
    .btn.primary{background:var(--accent); border-color:transparent; color:#052d16}
    .btn:disabled{opacity:.6; cursor:not-allowed}

    /* Mobiel */
    @media (max-width: 1100px){
      .panel{grid-template-columns:1fr; gap:20px; width:100vw; padding:clamp(4px, 2.8vw, 16px)}
      .title, .artists{text-align:center}
    }
    @media (max-width: 640px){
      .sheet{width:100vw; height:100vh; max-height:100vh; border-radius:0; padding:24px}
      .btns{justify-content:stretch}
      .btn{flex:1 1 100%}
    }
  </style>
</head>
<body>
  <div class="stage">

    <div class="panel">
      <div class="left">
        <img id="art" class="art" alt="Album art" />
      </div>
      <div class="right">
        <div class="title" id="title">Not playing</div>
        <div class="artists" id="artists">—</div>
        <div>
          <div class="progress"><div class="bar" id="bar"></div></div>
        </div>
      </div>
    </div>

    <div class="gear" id="gear" title="Settings (press 's')">⚙︎</div>

    <div class="drawer" id="drawer">
      <div class="sheet">
        <h2>Nowify Settings</h2>
        <p class="lead">Enter your Spotify Client ID and confirm the Redirect URI.</p>

        <div class="row">
          <label for="clientId">Client ID</label>
          <input id="clientId" placeholder="Spotify Client ID" inputmode="text" autocomplete="off" />
          <div class="hint">From <em>Spotify Developer Dashboard → Your App → Client ID</em>.</div>
          <div class="error" id="clientIdErr">Please enter your Client ID.</div>
        </div>

        <div class="row">
          <label for="redirectUri">Redirect URI</label>
          <input id="redirectUri" placeholder="https://USERNAME.github.io/REPO/" inputmode="url" />
          <div class="hint">Must exactly match the Redirect URI you added in Spotify app settings.</div>
          <div class="error" id="redirectErr">Please enter a valid Redirect URI (https://…).</div>
        </div>

        <div class="btns">
          <button class="btn" id="copyUrlBtn" title="Use current page as Redirect URI">Use this page URL</button>
          <button class="btn" id="clearBtn">Clear data</button>
          <button class="btn" id="logoutBtn">Log out</button>
          <button class="btn primary" id="loginBtn">Log in with Spotify</button>
          <button class="btn" id="closeBtn">Close</button>
        </div>

        <p class="hint">Tip: Press <b>s</b> anytime to open this panel. Tokens are stored only in this browser.</p>
      </div>
    </div>

    <div class="blackout" id="blackout" aria-hidden="true"></div>
    <div class="neterr" id="neterr" aria-live="polite"><div class="bubble">Network issue — trying to reconnect…</div></div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
  const $ = s => document.querySelector(s);
  const b64url = arr => btoa(String.fromCharCode(...new Uint8Array(arr))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
  const randVer = () => { const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-._~"; const a = new Uint8Array(64); crypto.getRandomValues(a); return Array.from(a, b => chars[b % chars.length]).join(""); };
  const toast=(m)=>{const t=$("#toast"); t.textContent=m; t.style.display="block"; setTimeout(()=>t.style.display="none",2600);};

  const POLL_MS = 5000;

  const store={ get k(){return JSON.parse(localStorage.getItem("nowify_cfg")||"{}")},
                set k(v){localStorage.setItem("nowify_cfg",JSON.stringify(v))},
                set(a,b){const o=this.k;o[a]=b;this.k=o}, get(a){return this.k[a]}, clear(){localStorage.removeItem("nowify_cfg")} };

  const SCOPES=[ "user-read-email","user-read-private","user-read-currently-playing","user-read-playback-state" ].join(" ");
  async function beginLogin(){
    const cid = $("#clientId").value.trim();
    const rid = $("#redirectUri").value.trim() || (location.origin + location.pathname);
    store.set("client_id", cid); store.set("redirect_uri", rid);

    let ok = true;
    $("#clientIdErr").style.display = cid ? "none" : "block";
    try{ const u = new URL(rid); if(u.protocol !== "https:" && u.protocol !== "http:") ok=false; }catch{ ok=false; }
    $("#redirectErr").style.display = ok ? "none" : "block";
    if(!cid || !ok){ toast("Please fix the highlighted fields."); return; }

    if(!("crypto" in window) || !("subtle" in crypto)){ toast("This browser doesn't support PKCE (WebCrypto)."); return; }

    const loginBtn = $("#loginBtn"); loginBtn.disabled = true; const prev=loginBtn.textContent; loginBtn.textContent="Opening Spotify…";

    const state = randVer(); const verifier = randVer();
    const digest = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(verifier));
    const challenge=b64url(digest);
    store.set("code_verifier",verifier); store.set("oauth_state",state);

    const url=new URL("https://accounts.spotify.com/authorize");
    url.searchParams.set("response_type","code");
    url.searchParams.set("client_id",cid);
    url.searchParams.set("scope",SCOPES);
    url.searchParams.set("redirect_uri",rid);
    url.searchParams.set("state",state);
    url.searchParams.set("code_challenge_method","S256");
    url.searchParams.set("code_challenge",challenge);
    location.href=url.toString();
    setTimeout(()=>{ try{ loginBtn.disabled=false; loginBtn.textContent=prev; }catch{} }, 4000);
  }
  async function exchangeCodeForToken(code){
    const clientId=store.get("client_id"); const redirectUri=store.get("redirect_uri") || (location.origin + location.pathname);
    const verifier=store.get("code_verifier");
    const body=new URLSearchParams({client_id:clientId, grant_type:"authorization_code", code, redirect_uri:redirectUri, code_verifier:verifier});
    const res=await fetch("https://accounts.spotify.com/api/token",{method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"}, body});
    if(!res.ok) throw new Error("Token exchange failed: "+res.status);
    const data=await res.json(); persistTokens(data); return data;
  }
  async function refreshToken(){
    const clientId=store.get("client_id"); const r=store.get("refresh_token"); if(!r) return;
    const body=new URLSearchParams({client_id:clientId, grant_type:"refresh_token", refresh_token:r});
    const res=await fetch("https://accounts.spotify.com/api/token",{method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"}, body});
    if(!res.ok) throw new Error("Refresh failed: "+res.status);
    const data=await res.json(); persistTokens(data,true); return data;
  }
  function persistTokens(d, keep=false){
    if(d.access_token) store.set("access_token", d.access_token);
    if(d.expires_in) store.set("expires_at", Date.now() + (d.expires_in-30)*1000);
    if(d.refresh_token) store.set("refresh_token", d.refresh_token);
    else if(keep){}
  }
  function logout(){ store.set("access_token",null); store.set("refresh_token",null); store.set("expires_at",0); }

  async function api(path){
    let at=store.get("access_token"); let exp=store.get("expires_at")||0;
    if(!at) throw new Error("No access token");
    if(Date.now()>exp){ try{ await refreshToken(); }catch(e){ console.error(e);} at=store.get("access_token"); }
    const res=await fetch("https://api.spotify.com/v1"+path,{headers:{Authorization:`Bearer ${at}`}});
    if(res.status===204) return null;
    if(res.status===401){ await refreshToken(); return api(path); }
    if(!res.ok) throw new Error("API "+path+" failed: "+res.status);
    return await res.json();
  }

  const art=$("#art"), titleEl=$("#title"), artistsEl=$("#artists");
  const bar=$("#bar");
  const blackout=$("#blackout"), neterr=$("#neterr");
  const setBlackout = on => blackout.style.display = on ? "block" : "none";
  const showNetErr = on => neterr.style.display = on ? "grid" : "none";

  let lastPosMs=null, lastDurMs=null, lastIsPlaying=false;
  const animateProgress=(posMs, durMs, isPlaying, horizonMs=5000)=>{
    if(!durMs || durMs<=0){ bar.style.transition="none"; bar.style.width="0%"; return; }
    const startPct = Math.max(0, Math.min(100, (posMs/durMs)*100));
    bar.style.transition = "none";
    bar.style.width = startPct + "%";
    void bar.offsetWidth;
    if(isPlaying){
      const dt = Math.min(horizonMs, Math.max(0, durMs - posMs));
      const endPct = Math.max(0, Math.min(100, ((posMs + dt)/durMs)*100));
      bar.style.transition = `width ${dt/1000}s linear`;
      bar.style.width = endPct + "%";
    }
  };

  function renderNothing(){
    titleEl.textContent="Nothing playing";
    artistsEl.textContent="—";
    art.src="";
    fitAll();
    showNetErr(false);
    setBlackout(true);
    lastPosMs=null; lastDurMs=null; lastIsPlaying=false;
    animateProgress(0, 0, false);
  }
  function renderPlayback(d){
    if(!d || !d.item){ renderNothing(); return; }
    const t=d.item;
    titleEl.textContent=t.name||"—";
    artistsEl.textContent=(t.artists||[]).map(a=>a.name).join(", ")||"—";
    const img=(t.album&&t.album.images&&t.album.images[0]&&t.album.images[0].url)||"";
    if(img){ art.src=img; }
    const dur=t.duration_ms||0, pos=d.progress_ms||0;
    lastDurMs=dur; lastPosMs=pos; lastIsPlaying=!!d.is_playing;
    fitAll();
    setBlackout(!d.is_playing);
    showNetErr(false);
    animateProgress(pos, dur, d.is_playing, 5000);
  }

  const lineHeightPx=(el, fs)=>{
    const st=getComputedStyle(el);
    let lh = parseFloat(st.lineHeight);
    if(Number.isNaN(lh) || st.lineHeight === "normal") lh = 1.06 * fs;
    return lh;
  };
  function fitElement(el, maxLines, minPx){
    el.classList.remove("clamp","title-2","title-3","artists-1","artists-2");
    el.style.fontSize = "";
    let fs = parseFloat(getComputedStyle(el).fontSize) || 40;
    const minSize = Math.max(minPx, 18);
    for(let i=0;i<28;i++){
      const lh = lineHeightPx(el, fs);
      const lines = Math.ceil(el.scrollHeight / lh);
      if(lines <= maxLines) break;
      fs *= 0.92;
      if(fs <= minSize){ fs = minSize; break; }
      el.style.fontSize = fs + "px";
    }
    const lh2 = lineHeightPx(el, fs);
    const lines2 = Math.ceil(el.scrollHeight / lh2);
    if(lines2 > maxLines){
      el.classList.add("clamp");
      if(el.id === "title"){ el.classList.add(maxLines >=3 ? "title-3" : "title-2"); }
      else{ el.classList.add(maxLines >=2 ? "artists-2" : "artists-1"); }
    }
  }
  function fitAll(){
    fitElement(titleEl, 3, 34);
    fitElement(artistsEl, 2, 28);
  }
  window.addEventListener("resize", fitAll);

  let timer=null, lastETag=null, consecutiveErrors=0;
  const ERROR_THRESHOLD = 3;
  async function tick(){
    try{
      const headers={}; if(lastETag) headers["If-None-Match"]=lastETag;
      let at=store.get("access_token"); if(!at){ showNetErr(false); setBlackout(false); return; }
      const res=await fetch("https://api.spotify.com/v1/me/player/currently-playing",{headers:{Authorization:`Bearer ${at}`,...headers}});
      if(res.status===401){ await refreshToken(); return; }
      if(res.status===204){ consecutiveErrors=0; showNetErr(false); renderNothing(); return; }
      if(res.status===304){
        consecutiveErrors=0; showNetErr(false);
        if(lastDurMs!=null && lastPosMs!=null && lastIsPlaying){
          lastPosMs = Math.min(lastPosMs + 5000, lastDurMs);
          animateProgress(lastPosMs, lastDurMs, true, 5000);
        }
        return;
      }
      if(!res.ok) throw new Error("Status "+res.status);
      lastETag = res.headers.get("ETag") || lastETag;
      const data=await res.json(); renderPlayback(data);
      consecutiveErrors=0; showNetErr(false);
    }catch(e){
      consecutiveErrors++;
      if(consecutiveErrors >= ERROR_THRESHOLD){ setBlackout(false); showNetErr(true); }
      console.error(e);
    }
  }
  function start(){ if(timer) clearInterval(timer); tick(); timer=setInterval(tick, 5000); }
  async function whoami(){ try{ await api("/me"); }catch{} }

  const drawer=$("#drawer"), gear=$("#gear");
  function openDrawer(){ drawer.classList.add("open"); setBlackout(false); showNetErr(false); }
  function closeDrawer(){ drawer.classList.remove("open"); }
  $("#loginBtn").onclick=beginLogin;
  $("#logoutBtn").onclick=()=>{ logout(); renderNothing(); toast("Logged out"); openDrawer(); };
  $("#closeBtn").onclick=closeDrawer;
  $("#clearBtn").onclick=()=>{ store.clear(); toast("Cleared stored data"); location.reload(); };
  $("#copyUrlBtn").onclick=()=>{ $("#redirectUri").value = location.origin + location.pathname; saveSettings(); toast("Copied current page as Redirect URI"); };

  function saveSettings(){ store.set("client_id", $("#clientId").value.trim()); store.set("redirect_uri", $("#redirectUri").value.trim()); }
  $("#clientId").addEventListener("input", saveSettings);
  $("#redirectUri").addEventListener("input", saveSettings);
  gear.onclick=openDrawer;
  document.addEventListener("keydown",(e)=>{
    if(e.key.toLowerCase()==="s") openDrawer();
    if(e.key==="Enter" && $("#drawer").classList.contains("open")){ e.preventDefault(); beginLogin(); }
  });

  let wl=null;
  async function lockScreen(){ try{ if("wakeLock" in navigator){ wl=await navigator.wakeLock.request("screen"); wl.addEventListener("release",()=>{}); } }catch(e){} }
  document.addEventListener("visibilitychange",()=>{ if(document.visibilityState==="visible" && wl && wl.released){ lockScreen(); } });

  (async function init(){
    $("#clientId").value = store.get("client_id") || "";
    $("#redirectUri").value = store.get("redirect_uri") || (location.origin + location.pathname);
    const params=new URLSearchParams(location.search);
    if(params.has("code")){
      try{
        const code=params.get("code"); const state=params.get("state");
        if(state !== store.get("oauth_state")) throw new Error("State mismatch");
        await exchangeCodeForToken(code);
        history.replaceState({}, "", store.get("redirect_uri") || (location.origin + location.pathname));
        toast("Logged in");
      }catch(e){ console.error(e); toast("Login failed. Open settings with 's' and check."); }
    }
    if(store.get("access_token")){
      await whoami();
      start();
      lockScreen();
      gear.classList.add("hidden");
      fitAll();
    }else{
      setBlackout(false); showNetErr(false);
      openDrawer();
    }
  })();
  </script>
</body>
</html>
